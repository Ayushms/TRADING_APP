<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Market Reflex Game</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .game-area {
            width: 100%;
            height: 300px;
            background: #000;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            border: 2px solid var(--glass-border);
        }

        .line {
            position: absolute;
            bottom: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--text-muted);
            opacity: 0.3;
        }

        .zone {
            position: absolute;
            height: 60px;
            width: 100%;
            opacity: 0.2;
        }

        .bg-green {
            background: var(--accent-green);
            bottom: 20px;
        }

        .bg-red {
            background: var(--accent-red);
            top: 20px;
        }

        #price-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            position: absolute;
            left: 50px;
            bottom: 50%;
            transition: bottom 0.1s linear;
        }
    </style>
</head>

<body>
    <div class="app-container" style="justify-content: center; align-items: center; flex-direction: column;">
        <div class="glass-panel" style="padding: 30px; width: 600px; text-align: center;">
            <h2>Market Reflex</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Click BUY when dot is in GREEN zone. Click SELL
                when dot is in RED zone.</p>

            <div class="game-area">
                <div class="zone bg-red"></div>
                <div class="zone bg-green"></div>
                <div class="line"></div>
                <div id="price-dot"></div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 20px; justify-content: center;">
                <button class="btn-buy" style="width: 100px;" onclick="checkHit('BUY')">BUY</button>
                <button class="btn-sell" style="width: 100px;" onclick="checkHit('SELL')">SELL</button>
            </div>

            <h3 id="score-display" style="margin-top: 20px;">Score: 0</h3>
            <div id="msg" style="height: 20px; margin-top: 10px; font-weight: bold;"></div>

            <br>
            <a href="hub.html" style="color: var(--text-muted);">Quit</a>
        </div>
    </div>

    <script>
        let score = 0;
        let active = true;
        const dot = document.getElementById('price-dot');
        let dotY = 50; // Percentage
        let direction = 1;
        let speed = 2; // Speed multiplier

        function gameLoop() {
            if (!active) return;

            // Random movement
            if (Math.random() < 0.05) direction *= -1;

            dotY += direction * speed;

            // Bounds
            if (dotY > 90) direction = -1;
            if (dotY < 10) direction = 1;

            dot.style.bottom = dotY + '%';

            requestAnimationFrame(gameLoop);
        }

        function checkHit(action) {
            // Green zone is bottom 20px to 80px approx (in CSS its bottom 20px height 60px -> 20%-?%)
            // Let's refine based on visual logic simulation:
            // .bg-green bound: bottom 20px (simulated ~7% to 27%)
            // .bg-red bound: top 20px (simulated ~73% to 93%)

            let success = false;

            if (action === 'BUY') {
                // Must be low (e.g. < 30%)
                if (dotY < 30) success = true;
            } else if (action === 'SELL') {
                // Must be high (e.g. > 70%)
                if (dotY > 70) success = true;
            }

            const msg = document.getElementById('msg');
            if (success) {
                score++;
                msg.innerText = "Nice! +â‚¹1,000";
                msg.style.color = "#00c853";
                // Add funds
                fetch('/api/wallet/add-funds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: 1000, source: 'MARKET_REFLEX_GAME' })
                });
            } else {
                score = Math.max(0, score - 1);
                msg.innerText = "Missed!";
                msg.style.color = "#ff5252";
            }
            document.getElementById('score-display').innerText = "Score: " + score;
        }

        gameLoop();
    </script>
</body>

</html>